<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity Logs - Super Admin Portal</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/style.css">
</head>

<body class="dashboard-body">

    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="../index.html" class="sidebar-brand"><i class="fas fa-graduation-cap"></i><span>EduPro
                    LMS</span></a>
        </div>
        <nav class="sidebar-menu">
            <ul class="list-unstyled">
                <li class="sidebar-menu-item"><a href="dashboard.html" class="sidebar-link"><i
                            class="fas fa-home"></i><span>Dashboard</span></a></li>
                <li class="sidebar-menu-item"><a href="announcements.html" class="sidebar-link"><i
                            class="fas fa-bullhorn"></i><span>Announcements</span></a></li>
                <li class="sidebar-menu-item"><a href="role-distribution.html" class="sidebar-link"><i
                            class="fas fa-user-shield"></i><span>Roles & Permissions</span></a></li>
                <li class="sidebar-menu-item"><a href="finance.html" class="sidebar-link"><i
                            class="fas fa-money-bill-wave"></i><span>Funds Management</span></a></li>
                <li class="sidebar-menu-item"><a href="salary.html" class="sidebar-link"><i
                            class="fas fa-wallet"></i><span>Salary Management</span></a></li>
                <li class="sidebar-menu-item"><a href="teacher-attendance.html" class="sidebar-link"><i
                            class="fas fa-clipboard-check"></i><span>Teacher Attendance</span></a></li>
                <li class="sidebar-menu-item"><a href="reports.html" class="sidebar-link"><i
                            class="fas fa-file-alt"></i><span>Reports</span></a></li>

                <li class="sidebar-menu-item"><a href="activity-logs.html" class="sidebar-link active"><i
                            class="fas fa-history"></i><span>Activity Logs</span></a></li>
            </ul>
        </nav>
        <div class="sidebar-footer p-3 mt-auto">
            <button class="btn btn-outline-light w-100" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>
                Logout</button>
        </div>
    </aside>

    <main class="main-content">
        <nav class="top-navbar">
            <div class="d-flex align-items-center">
                <button class="btn btn-link text-dark d-lg-none me-3" id="sidebarToggle"><i
                        class="fas fa-bars fs-4"></i></button>
                <h1 class="page-title mb-0">System Activity Logs</h1>
            </div>
            <div class="user-menu">
                <div class="user-avatar"><span>SA</span></div>
                <div class="d-none d-md-block ms-3">
                    <div class="fw-bold">Super Admin</div>
                    <div class="small text-muted">System Administrator</div>
                </div>
            </div>
        </nav>

        <div class="dashboard-content">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="mb-0 fw-bold"><i class="fas fa-filter text-primary me-2"></i> Filter Logs</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <select class="form-select" id="filterRole">
                                <option value="">All Roles</option>
                                <option value="admin">Admin</option>
                                <option value="teacher">Teacher</option>
                                <option value="student">Student</option>
                                <option value="superadmin">Super Admin</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="filterAction">
                                <option value="">All Actions</option>
                                <option value="Login">Login</option>
                                <option value="Create">Create</option>
                                <option value="Update">Update</option>
                                <option value="Delete">Delete</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control" id="searchUser" placeholder="Search User...">
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-primary w-100" onclick="applyFilters()">
                                <i class="fas fa-search me-2"></i> Applies Filters
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-4 mb-4">
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body text-center">
                            <h6 class="text-muted mb-2">Total Activities</h6>
                            <h3 class="fw-bold" id="statTotal">0</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body text-center">
                            <h6 class="text-muted mb-2">Today</h6>
                            <h3 class="fw-bold text-primary" id="statToday">0</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body text-center">
                            <h6 class="text-muted mb-2">This Week</h6>
                            <h3 class="fw-bold text-success" id="statWeek">0</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body text-center">
                            <h6 class="text-muted mb-2">Login Actions</h6>
                            <h3 class="fw-bold text-info" id="statLogins">0</h3>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold"><i class="fas fa-list text-success me-2"></i> Recent Activity</h5>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-success" onclick="exportLogsToExcel()">
                            <i class="fas fa-file-excel me-2"></i> Export to Excel
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="clearAllLogs()">Clear Logs</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Timestamp</th>
                                    <th>User</th>
                                    <th>Role</th>
                                    <th>Action</th>
                                    <th>Details</th>
                                    <th>IP Address</th>
                                </tr>
                            </thead>
                            <tbody id="logsTableBody">
                                <!-- Dynamic Content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/main.js"></script>
    <script src="../assets/js/activity-functions.js"></script>
    <script>
        protectPage('superadmin');

        let allLogs = [];

        document.addEventListener('DOMContentLoaded', function () {
            initDashboardUser();
            loadLogsData();
        });

        function loadLogsData() {
            allLogs = getLogs();
            updateStats();
            renderLogs(allLogs);
        }

        function updateStats() {
            const now = new Date();
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            const weekStart = todayStart - (7 * 24 * 60 * 60 * 1000);

            document.getElementById('statTotal').innerText = allLogs.length; // Max capped at 200 in func

            const todayCount = allLogs.filter(l => new Date(l.timestamp).getTime() >= todayStart).length;
            document.getElementById('statToday').innerText = todayCount;

            const weekCount = allLogs.filter(l => new Date(l.timestamp).getTime() >= weekStart).length;
            document.getElementById('statWeek').innerText = weekCount;

            const loginCount = allLogs.filter(l => l.action === 'Login').length;
            document.getElementById('statLogins').innerText = loginCount;
        }

        function applyFilters() {
            const role = document.getElementById('filterRole').value.toLowerCase();
            const action = document.getElementById('filterAction').value.toLowerCase();
            const user = document.getElementById('searchUser').value.toLowerCase();

            const filtered = allLogs.filter(item => {
                const matchRole = role ? item.role.toLowerCase() === role : true;
                const matchAction = action ? item.action.toLowerCase() === action : true;
                const matchUser = user ? item.user.toLowerCase().includes(user) : true;
                return matchRole && matchAction && matchUser;
            });

            renderLogs(filtered);
        }

        function renderLogs(list) {
            const tbody = document.getElementById('logsTableBody');
            tbody.innerHTML = '';

            if (list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No logs found</td></tr>';
                return;
            }

            list.forEach(log => {
                let badgeClass = 'text-bg-secondary';
                if (log.role === 'admin') badgeClass = 'text-bg-warning';
                if (log.role === 'teacher') badgeClass = 'text-bg-success';
                if (log.role === 'student') badgeClass = 'text-bg-primary';
                if (log.role === 'superadmin') badgeClass = 'text-bg-dark';

                let actionBadge = 'bg-secondary';
                if (log.action === 'Login') actionBadge = 'bg-info';
                if (log.action === 'Create') actionBadge = 'bg-success';
                if (log.action === 'Update') actionBadge = 'bg-warning text-dark';
                if (log.action === 'Delete') actionBadge = 'bg-danger';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="small text-muted">${new Date(log.timestamp).toLocaleString()}</td>
                    <td class="fw-bold">${log.user}</td>
                    <td><span class="badge ${badgeClass}">${log.role.toUpperCase()}</span></td>
                    <td><span class="badge ${actionBadge}">${log.action}</span></td>
                    <td>${log.details}</td>
                    <td class="small text-muted">${log.ip}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function clearAllLogs() {
            if (confirm('Clear all activity logs? This cannot be undone.')) {
                clearLogs();
                loadLogsData();
                showToast('Logs cleared', 'success');
            }
        }
    </script>
</body>

</html>